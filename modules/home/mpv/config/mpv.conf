############################################################
# mpv.conf — Intel Meteor Lake (i915/Xe) + Wayland (Niri/Hyprland)
# 
# Optimizasyon Hedefleri:
#  - YouTube/4K'da AV1 codec'ini kesinlikle devre dışı bırak (iGPU uyumsuzluğu)
#  - A/V desync sorunlarını çöz (audio-sync kullan)
#  - YouTube'da sadece TR/EN altyazı (bant genişliği tasarrufu)
#  - Canlı HLS/DASH yayınlarda düşük latency
#  - VP9'u h264'e tercih et (Intel QSV ile daha kararlı)
#  - Ağ kesintilerine dayanıklı akıllı buffer yönetimi
#  - Hyprland Wayland compositor ile maksimum uyum
############################################################

#######################
# GPU / Video Backend Ayarları
#######################
vo=gpu                          # GPU video çıkışı (Wayland için en kararlı)
gpu-api=opengl                  # OpenGL backend (Vulkan'dan daha olgun)
gpu-context=wayland              # Native Wayland context (XWayland'den kaçın)
hwdec=vaapi                      # Intel VAAPI donanım decode (iHD/i965 driver)
# hwdec=vaapi-copy               # Alternatif: PCIe üzerinden kopyalama (sorun varsa)

# Intel QuickSync & Meteor Lake Optimizasyonları
hwdec-codecs=h264,hevc,vp8,vp9  # AV1 HARİÇ codec'ler (VP9 için kritik!)
vd-lavc-fast=no                  # Fast mode KAPALI (kalite öncelikli)
vd-lavc-skiploopfilter=none      # Loop filter'ı ATLAMA (kalite korunur)
vd-lavc-check-hw-profile=yes     # Hardware profil uyumluluğunu kontrol et
vaapi-device=/dev/dri/renderD128 # Intel GPU'yu explicit belirt

# OpenGL İyileştirmeleri (Intel Xe için)
opengl-pbo=yes                   # Pixel Buffer Objects (daha hızlı texture upload)
opengl-early-flush=yes           # GL komutlarını erken flush et (latency azaltma)

# Shader Cache (ilk açılışlar sonrası hızlanma)
gpu-shader-cache-dir=~/.cache/mpv/shaders

# Wayland-Özel Optimizasyonlar
# `auto` daha uyumlu (Niri/Hyprland); compositor'la çakışma olursa "no" denenebilir.
wayland-internal-vsync=auto
wayland-edge-pixels-pointer=10   # Kenar algılama hassasiyeti (mouse)
wayland-edge-pixels-touch=10     # Kenar algılama hassasiyeti (dokunmatik)

#######################
# Video Senkronizasyon & Timing (A/V SYNC FIX)
#######################
video-sync=audio                 # AUDIO'YA KİTLE (YouTube/streaming için kritik)
interpolation=no                 # Frame interpolation KAPALI (sync sorunlarını önler)
framedrop=decoder                # Gerekirse frame drop et (sync'i koru)

# A/V Sync Toleransları (ARTIRILDI)
video-sync-max-video-change=0.125  # 125ms video değişim toleransı
video-sync-max-audio-change=0.125  # 125ms ses değişim toleransı

#######################
# Ölçekleme & Görüntü Kalitesi
#######################
scale=spline36                   # Upscaling (dengeli kalite/performans)
cscale=spline36                  # Chroma upscaling
dscale=mitchell                  # Downscaling (keskin, artifact'sız)

# Deband (gradient banding'i azalt, opsiyonel)
# deband=yes
# deband-iterations=2
# deband-threshold=48
# deband-range=16
# deband-grain=32

#######################
# Seek & Playback Davranışı
#######################
hr-seek=yes                      # High resolution seeking (frame-accurate)
hr-seek-framedrop=no             # HR-seek sırasında frame drop etme
save-position-on-quit=yes        # Çıkışta pozisyonu kaydet
resume-playback=yes              # Kaldığı yerden devam et
watch-later-directory=~/.cache/mpv/watch_later
prefetch-playlist=yes            # Playlist'teki sonraki videoyu önceden yükle

#######################
# Önbellek & I/O Optimizasyonu
#######################
demuxer-thread=yes               # Demuxer'ı ayrı thread'de çalıştır
cache=yes                        # Önbellek aktif

# Akıllı Buffer Yönetimi (ağ kesintilerine dayanıklı)
demuxer-readahead-secs=45        # 45 saniye ileri okuma
cache-secs=180                   # 3 dakika toplam önbellek
demuxer-max-bytes=250MiB         # Maksimum demux buffer (optimize edildi)
demuxer-max-back-bytes=100MiB    # Geri sarma buffer'ı

# Otomatik Duraklatma & Buffer Doldurma
cache-pause=yes                  # Buffer düşükse otomatik duraklat
cache-pause-wait=2.5             # 2.5 saniye buffer dolmasını bekle
cache-pause-initial=yes          # İlk yüklemede buffer dolana kadar bekle

#######################
# Performans & Threading
#######################
vd-lavc-threads=8                # Video decode thread sayısı (Meteor Lake 8-core için)
ad-lavc-threads=4                # Audio decode thread sayısı
vd-lavc-dr=yes                   # Direct rendering (kopyalamadan decode)
vd-lavc-assume-old-x264=no       # Modern x264 encoder varsay

#######################
# Ses Sistemi & Senkronizasyon
#######################
ao=pipewire                      # PipeWire ses sistemi (Wayland için ideal)
audio-pitch-correction=yes       # Hız değişimlerinde pitch düzeltmesi
audio-channels=stereo            # Stereo downmix
gapless-audio=weak               # Playlist'te gapless playback
audio-normalize-downmix=yes      # Downmix'te normalize et

# YouTube & Streaming Uyumlu Ses Ayarları
audio-samplerate=48000           # 48kHz (YouTube standart)
audio-buffer=0.15                # 150ms ses buffer'ı (optimize edildi)

# Ses Sistemi İyileştirmeleri (A/V SYNC İÇİN KRİTİK)
audio-stream-silence=yes         # Sessizlikte stream'i koru
audio-wait-open=0.5              # Ses açılmasını 0.5 saniye bekle
pulse-buffer=50                  # PulseAudio/PipeWire buffer (ms)
pulse-latency-hacks=yes          # Latency hack'leri aktif

#######################
# Pencere & Kullanıcı Arayüzü
#######################
input-ipc-server=/tmp/mpvsocket  # IPC socket (harici kontrol için)
border=no                        # Pencere kenarlığı yok
keep-open=yes                    # Video bitince pencereyi kapatma
idle=once                        # Boştayken uyku moduna geç
msg-color=yes                    # Renkli terminal çıktısı
msg-module=yes                   # Modül isimlerini göster
cursor-autohide=100              # 100ms sonra imleci gizle
cursor-autohide-fs-only=no       # Sadece fullscreen'de değil, her zaman
autofit=85%x85%                  # İlk açılış boyutu (ekranın %85'i)
autofit-larger=95%x95%           # Maksimum pencere boyutu
force-window=immediate           # Pencereyi hemen oluştur

# OSD (On-Screen Display) Görünümü
osc=no                           # Varsayılan OSC'yi kapat (özel skin kullanılabilir)
osd-bar=yes                      # İlerleme çubuğu göster
osd-bar-align-y=1                # Alt tarafa hizala
osd-bar-h=2                      # Çubuk yüksekliği
osd-bar-w=60                     # Çubuk genişliği (%)
osd-duration=2000                # OSD görünüm süresi (ms)
osd-level=1                      # OSD bilgi seviyesi
osd-font='Hack Nerd Font'        # OSD fontu
osd-font-size=24                 # Font boyutu
osd-color='#CCFFFFFF'            # Yazı rengi (yarı saydam beyaz)
osd-border-color='#DD322640'     # Kenarlık rengi
osd-border-size=1                # Kenarlık kalınlığı
osd-shadow-color='#000000'       # Gölge rengi
osd-shadow-offset=1              # Gölge mesafesi
osd-spacing=0.5                  # Satır aralığı

#######################
# Altyazı Ayarları
#######################
sub-auto=fuzzy                   # Benzer isimli altyazıları otomatik yükle
sub-file-paths-append=ass        # Altyazı arama dizinleri
sub-file-paths-append=srt
sub-file-paths-append=sub
sub-scale=1.0                    # Altyazı boyutu
sub-fix-timing=yes               # Zamanlama sorunlarını düzelt
sub-ass-override=force           # ASS stil override'ı zorla
sub-gauss=0.6                    # Gaussian blur (yumuşatma)
sub-filter-sdh=yes               # İşitme engelli notlarını filtrele
sub-filter-regex-warn=no         # Regex uyarılarını gösterme
sub-visibility=yes               # Altyazıları göster
blend-subtitles=no               # Video ile blend etme
sub-fonts-dir=~/.local/share/fonts
sub-font='Hack Nerd Font'        # Altyazı fontu
sub-font-size=36                 # Font boyutu
sub-color='#FFFFFF'              # Yazı rengi
sub-border-color='#000000'       # Kenarlık rengi
sub-border-size=2                # Kenarlık kalınlığı
sub-shadow-offset=1              # Gölge mesafesi
sub-shadow-color='#000000'       # Gölge rengi

#######################
# Ekran Görüntüsü Ayarları
#######################
screenshot-directory=~/Pictures/mpv-screenshots
screenshot-template="%F-%P"      # Dosya adı formatı (film-pozisyon)
screenshot-format=png            # PNG formatı (kayıpsız)
screenshot-high-bit-depth=yes    # Yüksek bit derinliği
screenshot-png-compression=7     # PNG sıkıştırma seviyesi (0-9)
screenshot-tag-colorspace=yes    # Renk uzayı bilgisini ekle

#######################
# Dil Tercihleri
#######################
slang=tur,tr,eng,en              # Altyazı dil sıralaması
alang=tur,tr,eng,en              # Ses dil sıralaması

#######################
# Ağ & Stream Dayanıklılığı
#######################
network-timeout=20               # Ağ zaman aşımı (saniye)
rtsp-transport=tcp               # RTSP için TCP kullan (daha güvenilir)
tls-verify=yes                   # TLS sertifika doğrulaması

# FFmpeg Ağ İyileştirmeleri
stream-lavf-o-append=reconnect_streamed=1           # Stream'lerde yeniden bağlan
stream-lavf-o-append=reconnect_on_network_error=1   # Ağ hatalarında yeniden bağlan
stream-lavf-o-append=reconnect_on_http_error=4xx,5xx # HTTP hatalarında yeniden bağlan
stream-lavf-o-append=reconnect_delay_max=30         # Maksimum yeniden bağlanma gecikmesi
stream-lavf-o-append=fflags=fastseek               # Hızlı seek
stream-lavf-o-append=multiple_requests=1            # Çoklu HTTP istekleri
stream-lavf-o-append=http_persistent=0              # YouTube CDN rotasyonu için persistent kapalı

#######################
# Log Seviyesi & Debug
#######################
# Gereksiz spam'i azalt ama kritik hataları göster
msg-level=ffmpeg=error            # FFmpeg sadece uyarı ve üstü
msg-level=demux=error             # Demuxer sadece uyarı ve üstü
msg-level=cplayer=error           # Core player sadece uyarı ve üstü
msg-level=vaapi=info              # VAAPI bilgilerini göster (hw decode takibi)

############################################################
# PROTOKOL PROFİLLERİ
############################################################

[protocol.https]
profile-desc="HTTPS/YouTube Optimized Streaming"
cache=yes
demuxer-max-bytes=200MiB
demuxer-readahead-secs=30
force-window=immediate

[protocol.http]
profile-desc="HTTP Streaming"
cache=yes
demuxer-max-bytes=100MiB
demuxer-readahead-secs=20
force-window=immediate

[protocol.file]
profile-desc="Local File Playback"
cache=no                         # Lokal dosyalar için cache gereksiz
demuxer-max-bytes=50MiB
force-seekable=yes
force-window=immediate

############################################################
# OTOMATİK PROFİLLER (lua script gerektirmez)
############################################################

# 1) YouTube — AV1 Engelleme, VP9 Önceliği, A/V Sync Fix
[youtube-content]
profile-desc="YouTube Optimizations - No AV1, Prefer VP9, Audio Sync"
profile-cond=path:match("youtu%.?be") ~= nil
profile=protocol.https
# Format seçimi: VP9 > H264, AV1 kesinlikle hariç, max 1080p60
ytdl-format=bestvideo*[height<=?1080][fps<=?60][vcodec*=vp9]+bestaudio/bestvideo*[height<=?1080][fps<=?60][vcodec*=avc1]+bestaudio/bestvideo*[height<=?1080][fps<=?60][vcodec!=av01][vcodec!=av1]+bestaudio/best
# YouTube optimizasyonları
ytdl-raw-options-append=sub-langs=tr,en             # Sadece TR/EN altyazı
ytdl-raw-options-append=format-sort=codec:vp9,codec:h264  # Codec öncelik sırası
ytdl-raw-options-append=no-playlist=                # Playlist'i otomatik yükleme
ytdl-raw-options-append=live-from-start=            # Canlı yayınları baştan başlatma
# YouTube için özel sync ayarları (KRİTİK)
video-sync=audio                                    # YouTube'da audio-sync ŞART
framedrop=decoder                                    # Frame drop ile sync koru
interpolation=no                                     # Interpolation KAPALI
demuxer-lavf-o-append=analyzeduration=2000000       # 2 saniye analiz (YouTube için yeterli)

# 2) 4K Video — AV1 Hariç, VP9 Öncelikli, Büyük Buffer
[4k-video]
profile-desc="4K Content Optimization"
profile-cond=width >= 3840 or height >= 2160
hwdec=vaapi                      # 4K için donanım decode şart
demuxer-max-bytes=500MiB         # 4K için büyük buffer
demuxer-readahead-secs=60        # Daha fazla ileri okuma
cache-secs=300                   # 5 dakika cache
video-sync=audio                 # 4K'da da audio sync
# 4K YouTube formatı (AV1 hariç)
ytdl-format=bestvideo*[height<=?2160][fps<=?60][vcodec*=vp9]+bestaudio/bestvideo*[height<=?2160][fps<=?60][vcodec*=avc1]+bestaudio/bestvideo*[height<=?2160][fps<=?60][vcodec!=av01][vcodec!=av1]+bestaudio/best
ytdl-raw-options-append=sub-langs=tr,en

# 3) Canlı HLS/DASH — Düşük Latency, Audio-Sync
[live-hls]
profile-desc="Live Streaming (HLS/DASH) - Low Latency"
video-sync=audio                 # Ses'e kitle (canlı yayın için ideal)
interpolation=no                 # Interpolation kapalı (latency azaltma)
cache=yes
cache-secs=10                    # Küçük cache (düşük latency)
demuxer-readahead-secs=12        # Minimal ileri okuma
hr-seek=no                       # HR-seek kapalı (performans)
audio-buffer=0.10                # Canlı için düşük ses buffer'ı
# Bozuk frame'leri atla
demuxer-lavf-o-append=fflags=+discardcorrupt
# Analiz süresini kısalt
demuxer-lavf-analyzeduration=5

# 3a) Otomatik HLS/m3u8 Algılama
[live-hls-auto]
profile-desc="Auto-detect HLS Streams"
profile-cond=(path and path:match("%.m3u8")) or (demuxer == "hls")
profile=live-hls

# 4) Twitch.tv Özel Optimizasyonları
[twitch]
profile-desc="Twitch.tv Streaming"
profile-cond=path:match("twitch%.tv") ~= nil
profile=live-hls
# Twitch için ekstra
demuxer-lavf-o-append=http_persistent=1
demuxer-lavf-o-append=http_multiple_requests=1

############################################################
# MANUEL PROFİLLER (--profile=name ile aktive edilir)
############################################################

# Acil Durum: Audio-Master Sync
[avsync-audio-master]
profile-desc="Force Audio Master Sync"
video-sync=audio
interpolation=no
framedrop=decoder+vo             # Agresif frame drop

# Maksimum Kalite (güçlü sistemler için)
[high-quality]
profile-desc="Maximum Quality Settings"
scale=ewa_lanczossharp
cscale=ewa_lanczossharp
dscale=mitchell
deband=yes
deband-iterations=4
deband-threshold=50
deband-range=16
deband-grain=48

# Vulkan Backend (deneysel)
[vulkan]
profile-desc="Vulkan Renderer (Experimental)"
vo=gpu-next
gpu-api=vulkan
gpu-context=wayland

# Düşük Latency Gaming/Recording
[low-latency]
profile-desc="Minimal Latency for Gaming/Recording"
video-sync=audio
interpolation=no
cache=no
demuxer-thread=no
audio-buffer=0.05
untimed=yes

# Sorun Giderme Profili
[fast]
profile-desc="Fast Profile for Troubleshooting"
vo=gpu
hwdec=no
video-sync=audio
interpolation=no
scale=bilinear
cscale=bilinear
dscale=bilinear

############################################################
# NOTLAR & İPUÇLARI
############################################################
# 1. A/V desync sorunu yaşarsan: --profile=avsync-audio-master
# 2. CPU yükü fazlaysa: --profile=fast
# 3. Canlı yayınlarda gecikme varsa: --profile=low-latency
# 4. 4K'da takılma varsa: --hwdec=vaapi-copy dene
# 5. Intel driver güncel mi kontrol et: vainfo
############################################################
