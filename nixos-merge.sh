#!/usr/bin/env bash

# NixOS Flake Branch Merge Script
# Bu script e14u7 branch'Ä±ndaki deÄŸiÅŸiklikleri x1c6'ya merge eder
# ama belirli dosyalarÄ± hariÃ§ tutar

set -e # Hata durumunda scripti durdur

# Renkli Ã§Ä±ktÄ± iÃ§in
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Exclude edilecek dosyalar
EXCLUDE_FILES=(
	"modules/home/hyprland/config.nix"
	"modules/core/power/default.nix"
	"hosts/hay/hardware-configuration.nix"
	"flake.json"
	"flake.lock"
)

# Kaynak ve hedef branch'lar
SOURCE_BRANCH="e14u7"
TARGET_BRANCH="x1c6"

echo -e "${BLUE}ğŸ”„ NixOS Branch Merge Script${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Git repo'da olduÄŸumuzu kontrol et
if ! git rev-parse --git-dir >/dev/null 2>&1; then
	echo -e "${RED}âŒ Bu dizin bir git repository deÄŸil!${NC}"
	exit 1
fi

# Branch'larÄ±n var olduÄŸunu kontrol et
if ! git show-ref --verify --quiet refs/heads/$SOURCE_BRANCH; then
	echo -e "${RED}âŒ $SOURCE_BRANCH branch'Ä± bulunamadÄ±!${NC}"
	exit 1
fi

if ! git show-ref --verify --quiet refs/heads/$TARGET_BRANCH; then
	echo -e "${RED}âŒ $TARGET_BRANCH branch'Ä± bulunamadÄ±!${NC}"
	exit 1
fi

# Temiz working directory kontrolÃ¼
if [ -n "$(git status --porcelain)" ]; then
	echo -e "${YELLOW}âš ï¸  Working directory temiz deÄŸil. Devam etmek istiyor musunuz? (y/N)${NC}"
	read -r response
	if [[ ! "$response" =~ ^[Yy]$ ]]; then
		echo -e "${RED}âŒ Ä°ÅŸlem iptal edildi${NC}"
		exit 1
	fi
fi

# Mevcut branch'Ä± kaydet
CURRENT_BRANCH=$(git branch --show-current)
echo -e "${BLUE}ğŸ“ Mevcut branch: $CURRENT_BRANCH${NC}"

# Target branch'a geÃ§
echo -e "${BLUE}ğŸ”„ $TARGET_BRANCH branch'Ä±na geÃ§iliyor...${NC}"
git checkout $TARGET_BRANCH

# Source branch'dan tÃ¼m dosyalarÄ± getir (ama commit etme)
echo -e "${BLUE}ğŸ“¥ $SOURCE_BRANCH branch'Ä±ndaki dosyalar getiriliyor...${NC}"
git checkout $SOURCE_BRANCH -- .

# Exclude edilecek dosyalarÄ± unstage et ve eski hallerine dÃ¶ndÃ¼r
echo -e "${BLUE}ğŸš« Exclude edilecek dosyalar iÅŸleniyor...${NC}"
for file in "${EXCLUDE_FILES[@]}"; do
	if [ -f "$file" ]; then
		echo -e "${YELLOW}   - $file exclude ediliyor...${NC}"
		git reset HEAD "$file" 2>/dev/null || true
		git checkout HEAD -- "$file" 2>/dev/null || true
	else
		echo -e "${YELLOW}   - $file bulunamadÄ±, atlanÄ±yor...${NC}"
	fi
done

# Staging area'daki dosyalarÄ± gÃ¶ster
echo -e "${BLUE}ğŸ“‹ Merge edilecek dosyalar:${NC}"
git diff --cached --name-only | while read -r file; do
	echo -e "${GREEN}   + $file${NC}"
done

# KullanÄ±cÄ±dan onay al
echo -e "${YELLOW}ğŸ¤” Bu deÄŸiÅŸiklikleri commit etmek istiyor musunuz? (y/N)${NC}"
read -r response

if [[ "$response" =~ ^[Yy]$ ]]; then
	# Commit mesajÄ± oluÅŸtur
	COMMIT_MSG="Merge from $SOURCE_BRANCH (excluding specific files)

Excluded files:
$(printf '- %s\n' "${EXCLUDE_FILES[@]}")

Auto-generated by nixos-merge script"

	# Commit et
	git add .
	git commit -m "$COMMIT_MSG"

	echo -e "${GREEN}âœ… Merge iÅŸlemi tamamlandÄ±!${NC}"
	echo -e "${GREEN}ğŸ“ Commit mesajÄ±: 'Merge from $SOURCE_BRANCH (excluding specific files)'${NC}"

	# Ã–zet gÃ¶ster
	echo -e "${BLUE}ğŸ“Š Ä°ÅŸlem Ã¶zeti:${NC}"
	echo -e "${GREEN}   âœ“ $SOURCE_BRANCH -> $TARGET_BRANCH merge edildi${NC}"
	echo -e "${YELLOW}   âš  ${#EXCLUDE_FILES[@]} dosya exclude edildi${NC}"

else
	echo -e "${YELLOW}âŒ Ä°ÅŸlem iptal edildi. DeÄŸiÅŸiklikler staging area'da bekliyor.${NC}"
	echo -e "${BLUE}ğŸ’¡ Ä°pucu: 'git reset --hard HEAD' ile deÄŸiÅŸiklikleri geri alabilirsiniz${NC}"
fi

# Orijinal branch'a dÃ¶nme seÃ§eneÄŸi
if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
	echo -e "${YELLOW}ğŸ”„ Orijinal branch ($CURRENT_BRANCH) 'a dÃ¶nmek istiyor musunuz? (y/N)${NC}"
	read -r response
	if [[ "$response" =~ ^[Yy]$ ]]; then
		git checkout "$CURRENT_BRANCH"
		echo -e "${GREEN}âœ… $CURRENT_BRANCH branch'Ä±na dÃ¶nÃ¼ldÃ¼${NC}"
	fi
fi

echo -e "${BLUE}ğŸ‰ Script tamamlandÄ±!${NC}"
