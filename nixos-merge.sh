#!/usr/bin/env bash

# NixOS Flake Branch Merge Script
# Bu script e14u7 branch'Ä±ndaki deÄŸiÅŸiklikleri x1c6'ya merge eder
# ama belirli dosyalarÄ± hariÃ§ tutar

set -e # Hata durumunda scripti durdur

# Renkli Ã§Ä±ktÄ± iÃ§in
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Exclude edilecek dosyalar
EXCLUDE_FILES=(
	"modules/home/hyprland/config.nix"
	"hosts/hay/hardware-configuration.nix"
	"flake.json"
	"flake.lock"
)

# Kaynak ve hedef branch'lar
SOURCE_BRANCH="e14u7"
TARGET_BRANCH="x1c6"

echo -e "${BLUE}ğŸ”„ NixOS Branch Merge Script${NC}"
echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Git repo'da olduÄŸumuzu kontrol et
if ! git rev-parse --git-dir >/dev/null 2>&1; then
	echo -e "${RED}âŒ Bu dizin bir git repository deÄŸil!${NC}"
	exit 1
fi

# Branch'larÄ±n var olduÄŸunu kontrol et
if ! git show-ref --verify --quiet refs/heads/$SOURCE_BRANCH; then
	echo -e "${RED}âŒ $SOURCE_BRANCH branch'Ä± bulunamadÄ±!${NC}"
	exit 1
fi

if ! git show-ref --verify --quiet refs/heads/$TARGET_BRANCH; then
	echo -e "${RED}âŒ $TARGET_BRANCH branch'Ä± bulunamadÄ±!${NC}"
	exit 1
fi

# Temiz working directory kontrolÃ¼
if [ -n "$(git status --porcelain)" ]; then
	echo -e "${YELLOW}âš ï¸  Working directory temiz deÄŸil. Devam etmek istiyor musunuz? (y/N)${NC}"
	read -r response
	if [[ ! "$response" =~ ^[Yy]$ ]]; then
		echo -e "${RED}âŒ Ä°ÅŸlem iptal edildi${NC}"
		exit 1
	fi
fi

# Mevcut branch'Ä± kaydet
CURRENT_BRANCH=$(git branch --show-current)
echo -e "${BLUE}ğŸ“ Mevcut branch: $CURRENT_BRANCH${NC}"

# Target branch'a geÃ§
echo -e "${BLUE}ğŸ”„ $TARGET_BRANCH branch'Ä±na geÃ§iliyor...${NC}"
git checkout $TARGET_BRANCH

# Source branch'dan tÃ¼m dosyalarÄ± getir (ama commit etme)
echo -e "${BLUE}ğŸ“¥ $SOURCE_BRANCH branch'Ä±ndaki dosyalar getiriliyor...${NC}"
# Merge stratejisi kullan (dosya silme iÅŸlemlerini de yakalar)
git merge --no-commit --no-ff $SOURCE_BRANCH || true

# Exclude edilecek dosyalarÄ± unstage et ve eski hallerine dÃ¶ndÃ¼r
echo -e "${BLUE}ğŸš« Exclude edilecek dosyalar iÅŸleniyor...${NC}"
for file in "${EXCLUDE_FILES[@]}"; do
	if [ -f "$file" ]; then
		echo -e "${YELLOW}   - $file exclude ediliyor...${NC}"
		git reset HEAD "$file" 2>/dev/null || true
		git checkout HEAD -- "$file" 2>/dev/null || true
	else
		echo -e "${YELLOW}   - $file bulunamadÄ±, atlanÄ±yor...${NC}"
	fi
done

# Staging area'daki dosyalarÄ± gÃ¶ster
echo -e "${BLUE}ğŸ“‹ Merge edilecek dosyalar:${NC}"
STAGED_FILES=$(git diff --cached --name-only)
if [ -z "$STAGED_FILES" ]; then
	echo -e "${YELLOW}   (HiÃ§bir dosya merge edilecek deÄŸil - zaten sync'te olabilirler)${NC}"
else
	git diff --cached --name-only | while read -r file; do
		echo -e "${GREEN}   + $file${NC}"
	done
fi

# KullanÄ±cÄ±dan onay al
if [ -z "$STAGED_FILES" ]; then
	echo -e "${GREEN}âœ… Ä°ki branch zaten sync'te! (Exclude edilen dosyalar hariÃ§)${NC}"

	# FarklarÄ± gÃ¶ster
	echo -e "${BLUE}ğŸ“Š Branch'lar arasÄ± farklar (sadece exclude edilen dosyalar):${NC}"
	DIFF_FILES=$(git diff $SOURCE_BRANCH..HEAD --name-only)
	if [ -n "$DIFF_FILES" ]; then
		echo "$DIFF_FILES" | while read -r file; do
			echo -e "${YELLOW}   â‰  $file${NC}"
		done
	else
		echo -e "${GREEN}   (HiÃ§bir fark yok)${NC}"
	fi
else
	echo -e "${YELLOW}ğŸ¤” Bu deÄŸiÅŸiklikleri commit etmek istiyor musunuz? (y/N)${NC}"
	read -r response

	if [[ "$response" =~ ^[Yy]$ ]]; then
		# Commit mesajÄ± oluÅŸtur
		EXCLUDED_LIST=""
		for file in "${EXCLUDE_FILES[@]}"; do
			EXCLUDED_LIST="${EXCLUDED_LIST}- ${file}\n"
		done

		COMMIT_MSG="Merge from $SOURCE_BRANCH (excluding specific files)

Excluded files:
${EXCLUDED_LIST}
Auto-generated by nixos-merge script"

		# Commit et
		git add .
		git commit -m "$COMMIT_MSG"

		echo -e "${GREEN}âœ… Merge iÅŸlemi tamamlandÄ±!${NC}"
		echo -e "${GREEN}ğŸ“ Commit mesajÄ±: 'Merge from $SOURCE_BRANCH (excluding specific files)'${NC}"

		# Ã–zet gÃ¶ster
		echo -e "${BLUE}ğŸ“Š Ä°ÅŸlem Ã¶zeti:${NC}"
		echo -e "${GREEN}   âœ“ $SOURCE_BRANCH -> $TARGET_BRANCH merge edildi${NC}"
		echo -e "${YELLOW}   âš  ${#EXCLUDE_FILES[@]} dosya exclude edildi${NC}"

	else
		echo -e "${YELLOW}âŒ Ä°ÅŸlem iptal edildi. DeÄŸiÅŸiklikler staging area'da bekliyor.${NC}"
		echo -e "${BLUE}ğŸ’¡ Ä°pucu: 'git reset --hard HEAD' ile deÄŸiÅŸiklikleri geri alabilirsiniz${NC}"
	fi
fi

# Push seÃ§eneÄŸi
echo -e "${YELLOW}ğŸ“¤ DeÄŸiÅŸiklikleri remote'a push etmek istiyor musunuz? (y/N)${NC}"
read -r response
if [[ "$response" =~ ^[Yy]$ ]]; then
	echo -e "${BLUE}ğŸ“¤ $TARGET_BRANCH branch'Ä± push ediliyor...${NC}"
	if git push; then
		echo -e "${GREEN}âœ… Push baÅŸarÄ±lÄ±!${NC}"
	else
		echo -e "${RED}âŒ Push baÅŸarÄ±sÄ±z! Manuel olarak 'git push' yapmanÄ±z gerekebilir.${NC}"
	fi
fi

# Orijinal branch'a dÃ¶nme seÃ§eneÄŸi
if [ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]; then
	echo -e "${YELLOW}ğŸ”„ Orijinal branch ($CURRENT_BRANCH) 'a dÃ¶nmek istiyor musunuz? (y/N)${NC}"
	read -r response
	if [[ "$response" =~ ^[Yy]$ ]]; then
		git checkout "$CURRENT_BRANCH"
		echo -e "${GREEN}âœ… $CURRENT_BRANCH branch'Ä±na dÃ¶nÃ¼ldÃ¼${NC}"

		# Orijinal branch'Ä± da push etmek ister mi?
		echo -e "${YELLOW}ğŸ“¤ $CURRENT_BRANCH branch'Ä±nÄ± da push etmek istiyor musunuz? (y/N)${NC}"
		read -r response
		if [[ "$response" =~ ^[Yy]$ ]]; then
			echo -e "${BLUE}ğŸ“¤ $CURRENT_BRANCH branch'Ä± push ediliyor...${NC}"
			if git push; then
				echo -e "${GREEN}âœ… $CURRENT_BRANCH push baÅŸarÄ±lÄ±!${NC}"
			else
				echo -e "${RED}âŒ Push baÅŸarÄ±sÄ±z! Manuel olarak 'git push' yapmanÄ±z gerekebilir.${NC}"
			fi
		fi
	fi
fi

echo -e "${BLUE}ğŸ‰ Script tamamlandÄ±!${NC}"
